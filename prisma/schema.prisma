// FitConnect Marketplace - Prisma Schema
// Production-ready database schema for freelance coach marketplace

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  CLIENT
  COACH
  ADMIN
}

enum PackageType {
  ONLINE
  IN_PERSON
}

enum BookingStatus {
  PENDING_PAYMENT
  CONFIRMED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  role         UserRole  @default(CLIENT)
  displayName  String?
  avatar       String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  coachProfile  CoachProfile?
  bookingsAsClient Booking[] @relation("ClientBookings")
  messagesAsSender Message[] @relation("MessageSender")
  reviewsAsClient  Review[]  @relation("ClientReviews")

  // Chat threads where user is client
  threadsAsClient ChatThread[] @relation("ClientThreads")
  // Chat threads where user is coach
  threadsAsCoach  ChatThread[] @relation("CoachThreads")

  @@index([email])
  @@index([role])
}


// ============================================
// COACH PROFILE
// ============================================

model CoachProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  displayName     String
  bio             String?  @db.Text
  tagline         String?
  location        String?
  specialties     String[]
  certifications  String[]
  languages       String[]
  responseTime    String?  // e.g., "Usually within 1 hour"
  startingRate    Int      @default(0) // in cents
  ratingAvg       Float    @default(0)
  ratingCount     Int      @default(0)
  sessionsCompleted Int    @default(0)
  
  // Stripe Connect
  stripeAccountId String?  @unique
  stripeOnboarded Boolean  @default(false)
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  gallery   CoachGalleryImage[]
  packages  Package[]
  bookings  Booking[]         @relation("CoachBookings")
  reviews   Review[]          @relation("CoachReviews")

  @@index([location])
  @@index([specialties])
  @@index([ratingAvg])
  @@index([isActive])
}

model CoachGalleryImage {
  id        String   @id @default(cuid())
  coachId   String
  url       String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  // Relations
  coach CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@index([coachId])
}

// ============================================
// PACKAGES
// ============================================

model Package {
  id          String      @id @default(cuid())
  coachId     String
  title       String
  description String?     @db.Text
  durationMins Int
  priceCents  Int
  currency    String      @default("usd")
  type        PackageType
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  coach    CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([coachId])
  @@index([isActive])
}

// ============================================
// BOOKINGS & PAYMENTS
// ============================================

model Booking {
  id              String        @id @default(cuid())
  coachId         String
  clientId        String
  packageId       String
  
  startTime       DateTime
  endTime         DateTime
  status          BookingStatus @default(PENDING_PAYMENT)
  
  // Amounts in cents
  amountCents     Int
  platformFeeCents Int
  payoutCents     Int
  currency        String        @default("usd")
  
  // Stripe
  stripePaymentIntentId String? @unique
  
  cancelledAt     DateTime?
  cancelReason    String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  coach    CoachProfile @relation("CoachBookings", fields: [coachId], references: [id])
  client   User         @relation("ClientBookings", fields: [clientId], references: [id])
  package  Package      @relation(fields: [packageId], references: [id])
  payment  Payment?
  review   Review?

  // Prevent double bookings: unique constraint on coach + start time
  @@unique([coachId, startTime])
  @@index([clientId])
  @@index([coachId, status])
  @@index([startTime])
  @@index([status])
}

model Payment {
  id                    String        @id @default(cuid())
  bookingId             String        @unique
  stripePaymentIntentId String        @unique
  status                PaymentStatus @default(PENDING)
  
  amountCents           Int
  platformFeeCents      Int
  payoutCents           Int
  currency              String        @default("usd")
  
  // Raw webhook data for debugging
  rawWebhookJson        Json?
  
  paidAt                DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([stripePaymentIntentId])
  @@index([status])
}

// ============================================
// CHAT
// ============================================

model ChatThread {
  id            String    @id @default(cuid())
  coachId       String
  clientId      String
  lastMessageAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  coach    User      @relation("CoachThreads", fields: [coachId], references: [id])
  client   User      @relation("ClientThreads", fields: [clientId], references: [id])
  messages Message[]

  // One thread per coach-client pair
  @@unique([coachId, clientId])
  @@index([coachId])
  @@index([clientId])
  @@index([lastMessageAt])
}

model Message {
  id        String    @id @default(cuid())
  threadId  String
  senderId  String
  content   String    @db.Text
  readAt    DateTime?
  createdAt DateTime  @default(now())

  // Relations
  thread ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender User       @relation("MessageSender", fields: [senderId], references: [id])

  @@index([threadId, createdAt])
  @@index([senderId])
}

// ============================================
// REVIEWS
// ============================================

model Review {
  id        String   @id @default(cuid())
  bookingId String   @unique
  coachId   String
  clientId  String
  rating    Int      // 1-5
  text      String?  @db.Text
  createdAt DateTime @default(now())

  // Relations
  booking Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  coach   CoachProfile @relation("CoachReviews", fields: [coachId], references: [id])
  client  User         @relation("ClientReviews", fields: [clientId], references: [id])

  @@index([coachId])
  @@index([rating])
}
